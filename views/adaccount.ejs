<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook Campaign Details</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

</head>
<body>
    <h1 class="text-center my-3">Facebook Ad-Accounts</h1>
    
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <form>
                    <div id="adaccount_id" class="my-3">
                        <label for="adaccount_list" class="form-label">Ad Account List: </label>
                        <select class="form-select mt-3" id="adaccount_list" aria-label="Select Ad Accounts">
                            <option selected>Open this select menu</option>
                            <% res.forEach((item) => { %>
                                <option value="<%=item.id %>"><%=item.name %></option>
                            <% }); %>
                        </select>
                        <button type="button" id="fetch_campaign" class="btn btn-primary my-3">Fetch Campaign</button>
                    </div>
                    <div id="campaign_div" class="mb-3" style="display:none;">
                        <label for="campaign_list" class="form-label">Campaign List: </label>
                        <select class="form-select mt-3" id="campaign_list" aria-label="Select Campaign">
                        </select>
                        <button type="button" id="fetch_adsets" class="btn btn-primary my-3">Fetch Adsets</button>
                    </div>
                    <div id="adset_div" class="mb-3" style="display:none;">
                        <label for="adset_list" class="form-label">Adset List: </label>
                        <select class="form-select mt-3" id="adset_list" aria-label="Select Adsets">
                        </select>
                        <button type="button" id="fetch_details" class="btn btn-primary my-3">Fetch Details</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div id="details_div" style="display:none;">
                    <h3 class="text-center">Campaign Details</h3>
                    <table class="table table-bordered table-striped">
                        <thead>
                            <tr>
                              <th scope="col">Clicks</th>
                              <th scope="col">Impression</th>
                              <th>Spend</th>
                              <th>Reach</th>
                              <th>Cost Per Unique Click</th>
                              <th>CPC</th>
                              <th>CPM</th>
                              <th>CPP</th>
                              <th>CTR</th>
                              <th>Video Avg Time Watched Actions</th>
                            </tr>
                          </thead>
                        <tbody id="details_body"> 
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function (){
            $('button#fetch_campaign').on('click', function () {
                var adaccount_id =  $('#adaccount_list').find(":selected").val();
                console.log(adaccount_id);
                if(adaccount_id){
                    $.ajax({                                      
                        url: `/api/fetch/campaign/${adaccount_id}`,              
                        type: "get",          
                        dataType: 'json',                
                        success: (res) => {
                            if(res){
                                $('#campaign_div').show();
                                $('#campaign_list').empty();
                                $('#campaign_list').append(`<option selected>Open this select menu</option>`);
                                for(i = 0; i < res.length; i++) { 
                                    $('#campaign_list').append(`<option value="${res[i].id}">${res[i].name}</option>`);
                                }
                            }
                            else{
                                $('#campaign_list').empty();
                                $('#campaign_div').hide();
                            }
                        }
                    });
                }
            });

            $('button#fetch_adsets').on('click', function () {
                var campaign_id =  $('#campaign_list').find(":selected").val();
                if(campaign_id){
                    $.ajax({                                      
                        url: `/api/fetch/adsets/${campaign_id}`,              
                        type: "get",          
                        dataType: 'json',                
                        success: (res) => {
                            if(res){
                                $('#adset_div').show();
                                $('#adset_list').empty();
                                $('#adset_list').append(`<option selected>Open this select menu</option>`);
                                for(i = 0; i < res.length; i++) { 
                                    $('#adset_list').append(`<option value="${res[i].id}">${res[i].name}</option>`);
                                }
                            }
                            else{
                                $('#adset_list').empty();
                                $('#adset_div').hide();
                            }
                        }
                    });
                }
            });

            $('button#fetch_details').on('click', function () {
                var adset_id =  $('#adset_list').find(":selected").val();
                if(adset_id){
                    $.ajax({                                                   
                        url: `/api/fetch/insights/${adset_id}`,              
                        type: "get",          
                        dataType: 'json',                
                        success: (res) => {
                            $('#details_div').show();
                            $('#details_body').empty();
                            if(res){
                                for(i = 0; i < res.length; i++) { 
                                    $('#details_body').append(`
                                        <tr>
                                            <td>${res[i].clicks}</td>
                                            <td>${res[i].impressions}</td>
                                            <td>${res[i].spend}</td>
                                            <td>${res[i].reach}</td>
                                            <td>${res[i].cost_per_unique_click}</td>
                                            <td>${res[i].cpc}</td>
                                            <td>${res[i].cpm}</td>
                                            <td>${res[i].cpp}</td>
                                            <td>${res[i].ctr}</td>
                                            <td><table class="table table-bordered"><tr><td>${res[i].video_avg_time_watched_actions ? res[i].video_avg_time_watched_actions[0].action_type: "N/A"}</td><td>${res[i].video_avg_time_watched_actions ? res[i].video_avg_time_watched_actions[0].value : "N/A"}</td></tr></table></td>
                                        </tr>
                                        `);
                                }
                            }
                            else{
                                $('#details_body').empty();
                            }
                        }
                    });
                }
            });
        });
    </script>
</body>
</html>